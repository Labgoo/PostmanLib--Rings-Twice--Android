package com.whiterabbit.postman.commands;

import android.content.Context;
import android.os.Parcel;
import android.util.Log;
import com.whiterabbit.postman.exceptions.ResultParseException;
import com.whiterabbit.postman.oauth.OAuthHelper;
import com.whiterabbit.postman.oauth.OAuthServiceInfo;
import com.whiterabbit.postman.utils.Constants;
import org.scribe.exceptions.OAuthException;
import org.scribe.model.OAuthRequest;
import org.scribe.model.Response;
import org.scribe.model.Verb;


/**
 * Server command implementation intended to be used to interact with a rest server
 * @author fede
 *
 */
public class RestServerCommand extends ServerCommand  {
    private RestServerStrategy mStrategy;

    /**
     * Constructor
     */
    public RestServerCommand(RestServerStrategy strategy){
        mStrategy = strategy;
    }

    @Override
    public int describeContents() {
        return 0;  //TODO Autogenerated
    }

    public void writeToParcel(Parcel parcel, int i) {
        parcel.writeParcelable(mStrategy, 0);
    }

    protected RestServerCommand(Parcel in){
        mStrategy = in.readParcelable(RestServerStrategy.class.getClassLoader());

    }

    public static final Creator<RestServerCommand> CREATOR
            = new Creator<RestServerCommand>() {
        public RestServerCommand createFromParcel(Parcel in) {
            return new RestServerCommand(in);
        }

        public RestServerCommand[] newArray(int size) {
            return new RestServerCommand[size];
        }
    };





    /**
     * Utility method to be used for mocking up request objects
     * inside unit tests
     * @param v
     * @param url
     * @return
     */
    protected OAuthRequest getRequest(Verb v, String url){
        return new OAuthRequest(v, url);
    }


	/**
	 * The real execution of the command. Performs the basic rest interaction
	 */
	@Override
	public void execute(Context c) {

        try {
            OAuthRequest request = getRequest(mStrategy.getVerb(), mStrategy.getUrl());
            mStrategy.addParamsToRequest(request);

            String signer = mStrategy.getOAuthSigner();
            if(signer != null){
                OAuthServiceInfo s = OAuthHelper.getInstance().getRegisteredService(signer, c);
                s.getService().signRequest(s.getAccessToken(), request);
            }
            Response response = request.send();
            handleResponse(response.getCode(), response, c);

        }catch(OAuthException e){
            notifyError(e.getMessage(), c);
            return;
        }

    }




	private void handleResponse(int statusCode, Response response, Context c) {
		switch(statusCode){
			case 200:
				if(response != null){
                    try {
                        mStrategy.processHttpResult(response, c);
                    }catch(ResultParseException e){
                        notifyError("Failed to parse result " + e.getMessage(), c);
                        Log.e(Constants.LOG_TAG, "Result parse failed: " + response);
                    }
                }
                notifyResult("Ok",  c);
            break;
            case 204:
                notifyResult("Ok",  c);
            break;
            case 404:
                notifyError("Not found" ,  c);
            break;
            case 401:
                notifyError("No permission" ,  c);
                // TODO Invalidate token ??
            break;
            default:
                notifyError("Generic error " + statusCode, c);
        }
	}
	


}
